<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>越南语口语练习</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding-bottom: 300px;
            background-color: #f7fbf3;
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px);
        }
        #infoBox {
            width: 95%;
            max-width: 700px;
            min-height: 100px;
            margin: 0 auto;
            border: 2px solid #91b66f;
            background: #85ae5f;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox {
            width: 90%;
            max-width: 700px;
            min-height: 25px;
            margin: 0px auto;
            border: 2px solid #91b66f;
            background: #85ae5f;
            color: #f1c232;
            display: flex;
            align-items: center;
            justify-content: left;
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px);
            font-weight: bold;
        }
        #instructionBox {
            width: 90%;
            max-width: 700px;
            min-height: 25px;
            margin: 0px auto;
            border: 2px solid #91b66f;
            background: #85ae5f;
            color: #f7e19c;
            display: flex;
            align-items: center;
            justify-content: left;
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px);
            font-weight: bold;
        }
        #controls {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px;
            background: #f7fbf3;
            border: 3px solid #f7fbf3;
            padding: 10px 0;
            z-index: 1000;
        }
        #controls div {
            margin: 5px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button {
            padding: 8px 8px;
            margin: 0 5px;
            cursor: pointer;
            border: 2px solid #85ae5f;
            background: #85ae5f;
            box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #fffbef;
            font-size: 28px;
            border-radius: 5px;
        }
        #sentenceNumber {
            width: 50px;
            padding: 10px;
            text-align: center;
            border: 3px solid #85ae5f;
            background: #f1cc76;
            color: #000;
            border-radius: 10px;
            font-size: 16px;
            -moz-appearance: textfield;
        }
        #sentenceNumber::-webkit-inner-spin-button,
        #sentenceNumber::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #sentenceNumber:disabled {
            background: #eee;
        }
        .disabled {
            cursor: not-allowed;
            pointer-events: none;
        }
        .active-mode {
            border: 2px solid #fed16a;
        }
        #indicator {
            width: 90%; 
            max-width: 650px;
            min-height: 50px;
            margin: 10px auto;
            padding: 5px;
            border: 3px solid #fed16a;
            background: #ffffe0;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            white-space: pre-line;
            font-size: clamp(16px, 2.5vw, 20px);
            text-align: left;
            padding-left: 20px;
        }
        #guideBox {
            width: 95%;
            max-width: 700px;
            margin: 10px auto;
            padding: 15px;
            border: 2px solid #85ae5f;
            background: #dae6cf;
            color: #4f6839;
            border-radius: 10px;
            text-align: left;
            font-size: clamp(14px, 1.8vw, 16px);
            line-height: 1.6;
        }
        #guideBox h4 {
            margin-top: 0;
            color: #27341c;
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        #results {
            display: none;
            width: 95%;
            max-width: 700px;
            margin: 10px auto;
            padding: 10px;
            border: 2px solid #734A2E;
            background: #fffbef;
            color: #000;
            font-size: 30px;
            text-align: left;
            border-radius: 5px;
            white-space: pre-line;
        }
        
        #recordControls {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
		/* thiết lập riêng cho nút record*/
		rc {
            padding: 5px 5px;
            margin: 0 5px;
            cursor: pointer;
            border: 10px solid #ee7446;
            background: #85ae5f;
            box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #fffbef;
            font-size: 20px;
            border-radius: 20px;		
		}

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px;
            }
            #controls {
                padding: 5px 0;
            }
            button {
                padding: 6px 6px;
                font-size: 20px;
            }
			rc {
			    padding: 3px 3px;
                font-size: 16px;
			}
            #sentenceNumber {
                width: 40px;
                padding: 8px;
                font-size: 14px;
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px);
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px);
            }
            #indicator {
			width: 90%;
            min-height: 40px;
            }
			#guideBox {
            width: 90%;
			}
            #results {
                font-size: 24px;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>口语练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">听问题并录音回答</div>
        <div id="indicator"></div>
        <div id="guideBox">
            <h4>使用说明：</h4>
            <ul>
                <li>【自由模式】：浏览口语题目内容。点击〖显示-隐藏〗按钮可查看题目内容。</li>
                <li>【作业模式】：听题目内容并录制回答。</li>
                <li>听完题目内容后，请点击〖录音〗按钮开始作答。</li>
                <li>回答完成后点击〖停止录音〗结束录制。</li>
                <li>可通过〖检查录音〗按钮回放录制内容，若不满意可再次点击〖录音〗重新录制。</li>
                <li>点击〖继续〗按钮进入下一题。</li>
                <li>完成最后一道题后，点击〖继续〗将会把所有录音文件打包成.ZIP压缩包，请将该文件发送给老师。</li>
				<li> 温馨提示：微信内直接打开链接不支持下载.ZIP压缩文件。请使用其他浏览器打开链接即可正常使用。</li>
            </ul>
        </div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
    </div>
    <div id="controls">
        <div id="freeModeControls">
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div id="testModeControls">
            <rc id="recordBtn">录音</rc>
            <button id="checkRecordBtn">检查录音</button>
            <button id="continueBtn">继续</button>
        </div>
        <div id="navControls">
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio"></audio>
    <audio id="signalAudio" src="YeuCau.mp3"></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        const audio = document.getElementById('mainAudio');
        const signalAudio = document.getElementById('signalAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const resultsDisplay = document.getElementById('results');
        
        const freeModeControls = document.getElementById('freeModeControls');
        const testModeControls = document.getElementById('testModeControls');
        const navControls = document.getElementById('navControls');

        const recordBtn = document.getElementById('recordBtn');
        const checkRecordBtn = document.getElementById('checkRecordBtn');
        const continueBtn = document.getElementById('continueBtn');
        
        let currentIndex = 0;
        let isFreeMode = true;
        let showQuestion = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordedAnswers = [];
        let isRecording = false;

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0.110459,
        "end": 4.064895,
        "Question": "Bạn tên là gì? Bạn là người nước nào?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.374181,
        "end": 10.118054,
        "Question": "Bạn sinh ngày, tháng, năm nào? Năm nay bạn bao nhiêu tuổi ?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 10.493615,
        "end": 13.188817,
        "Question": "Bạn hãy giới thiệu về gia đình mình?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 13.476011,
        "end": 17.187437,
        "Question": "Bạn thấy ấn tượng nhất với điều gì ở Việt Nam?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 17.562998,
        "end": 22.312739,
        "Question": "Từ nơi bạn ở đến đây có xa không? đi mất bao lâu?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 22.666209,
        "end": 25.47187,
        "Question": "Bạn đến đây bằng phương tiện gì?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 25.869523,
        "end": 30.243703,
        "Question": "Mục tiêu thi năng lực tiếng Việt của bạn là đạt được trình độ nào?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 30.707631,
        "end": 36.142219,
        "Question": "Bạn đang làm gì? Bạn có thích ngành học hay công việc hiện tại của mình không?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 36.341046,
        "end": 39.168799,
        "Question": "Buổi tối bạn thường làm gì?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 39.433901,
        "end": 44.75803,
        "Question": "Bạn học tiếng Việt bao lâu rồi? Hãy chia sẻ quá trình học tiếng Việt của bạn?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 44.978948,
        "end": 47.475324,
        "Question": "Hãy nói về một sở thích của bạn?"
    },
    {
        "audioFile": "audio.mp3",
        "start": 47.740426,
        "end": 52.909912,
        "Question": "Hãy giới thiệu cho tôi biết một địa điểm du lịch nổi tiếng ở đất nước bạn?"
    }
];

        // Hàm chuyển đổi định dạng audio từ WebM sang WAV
        function convertToWav(blob) {
            return new Promise((resolve, reject) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const fileReader = new FileReader();

                fileReader.onload = function() {
                    audioContext.decodeAudioData(this.result, (buffer) => {
                        const wavBuffer = audioBufferToWav(buffer);
                        const wavBlob = new Blob([wavBuffer], { type: 'audio/wav' });
                        resolve(wavBlob);
                    }, reject);
                };
                fileReader.readAsArrayBuffer(blob);
            });
        }

        // Hàm tạo file WAV từ AudioBuffer
        function audioBufferToWav(buffer) {
            const numOfChannels = buffer.numberOfChannels;
            const bytesPerSample = 2; // 16-bit
            const blockAlign = numOfChannels * bytesPerSample;
            const sampleRate = buffer.sampleRate;
            
            const numSamples = buffer.length;
            const dataLength = numSamples * numOfChannels * bytesPerSample;
            const byteLength = 44 + dataLength;

            const arrayBuffer = new ArrayBuffer(byteLength);
            const view = new DataView(arrayBuffer);
            
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, byteLength - 8, true);
            writeString(view, 8, 'WAVE');
            
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);
            
            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            
            // Write the data
            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                for (let channel = 0; channel < numOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    const int16Sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset, int16Sample, true);
                    offset += 2;
                }
            }

            return view;
        }

        function disableButtons(disable = true) {
            const btns = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, showHideBtn, recordBtn, checkRecordBtn, continueBtn];
            btns.forEach(btn => {
                btn.disabled = disable;
                if (disable) {
                    btn.classList.add('disabled');
                } else {
                    btn.classList.remove('disabled');
                }
            });
            sentenceNumber.disabled = disable;
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            let questionText = sentences[currentIndex].Question;

            if (isFreeMode) {
                indicator.innerHTML = showQuestion ? `<div style="font-weight: bold; color: #85ae5f; text-align: left;">${questionText}</div>` : '';
            } else {
                indicator.innerHTML = '';
            }
        }
        
        function updateUIForMode() {
            if (isFreeMode) {
                freeModeControls.style.display = 'flex';
                testModeControls.style.display = 'none';
                navControls.style.display = 'flex';
                showHideBtn.style.display = 'inline-block';
                document.getElementById('instructionBox').textContent = '听问题并录音回答';
            } else {
                freeModeControls.style.display = 'flex';
                testModeControls.style.display = 'flex';
                navControls.style.display = 'flex';
                showHideBtn.style.display = 'none';
                document.getElementById('instructionBox').textContent = '作业模式';
            }
            navControls.style.display = 'flex';
            checkRecordBtn.style.display = 'inline-block';
            continueBtn.style.display = 'inline-block';
            recordBtn.style.display = 'inline-block';
        }

        function playCurrentSentence(callback) {
            disableButtons(true);
            const currentSentence = sentences[currentIndex];
            audio.src = currentSentence.audioFile;
            audio.currentTime = currentSentence.start;

            const onTimeUpdate = () => {
                if (audio.currentTime >= currentSentence.end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    disableButtons(false);
                    if (callback) callback();
                }
            };
            audio.ontimeupdate = onTimeUpdate;
            
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                disableButtons(false);
            });
        }
        
        function playQuestionAndSignal() {
            disableButtons(true);
            playCurrentSentence(() => {
                signalAudio.play().catch(error => {
                    console.error('Signal audio playback failed:', error);
                    disableButtons(false);
                });
            });
        }
        
        signalAudio.onended = () => {
            disableButtons(false);
        };
        
        function startRecording(callback) {
            if (isRecording) {
                alert('Đang ghi âm!');
                return;
            }
            disableButtons(true);
            recordBtn.disabled = false;
            recordBtn.classList.remove('disabled');

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { 'type' : 'audio/webm' });
                        convertToWav(audioBlob)
                            .then(wavBlob => {
                                recordedAnswers[currentIndex] = wavBlob;
                                audioChunks = [];
                                recordBtn.textContent = '录音';
                                recordBtn.style.background = '#85ae5f';
                                isRecording = false;
                                disableButtons(false);
                                if (callback) callback();
                            })
                            .catch(error => {
                                console.error('Lỗi chuyển đổi sang WAV:', error);
                                alert('Không thể chuyển đổi file ghi âm.');
                                disableButtons(false);
                            });
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.textContent = '停止录音';
                    recordBtn.style.background = '#5b5b5b';
					recordBtn.style.color = '#ffffff';
					recordBtn.style.border = '10px solid #ee7446';
					/* recordBtn.style.borderRadius = '20px'; */
					/* recordBtn.style.fontSize = '20px'; */
					/* recordBtn.style.padding = '5px'; */
                })
                .catch(error => {
                    console.error('Lỗi khi truy cập micro:', error);
                    alert('Không thể truy cập microphone. Vui lòng cho phép truy cập.');
                    disableButtons(false);
                });
        }
        
        function stopRecording() {
            if (isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                recordBtn.textContent = '录音';
                recordBtn.style.background = '#85ae5f';
            }
        }
        
        function playRecordedAudio(blob) {
            if (blob) {
                disableButtons(true);
                const audioUrl = URL.createObjectURL(blob);
                const playbackAudio = new Audio(audioUrl);
                playbackAudio.play();
                playbackAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    disableButtons(false);
                }
            } else {
                alert('Chưa có bản ghi âm.');
            }
        }
        
        function checkAndPlayRecording() {
            if (isRecording) {
                stopRecording();
                // Logic phát lại sẽ được kích hoạt sau khi mediaRecorder.onstop hoàn thành
            } else {
                playRecordedAudio(recordedAnswers[currentIndex]);
            }
        }
        
        async function saveRecordings() {
            const zip = new JSZip();
            
            for (let i = 0; i < sentences.length; i++) {
                const folder = zip.folder(`Q${i + 1}`);
                
                // Thêm file txt câu hỏi
                const questionText = sentences[i].Question;
                folder.file('Question.txt', questionText);
                
                // Thêm file ghi âm câu trả lời (đã chuyển đổi sang WAV)
                if (recordedAnswers[i]) {
                    folder.file(`Answer_Q${i + 1}.wav`, recordedAnswers[i]);
                }
            }

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    saveAs(content, "越南语口语练习1.zip");
                });
        }
        
        function resetTestMode() {
            currentIndex = 0;
            recordedAnswers = [];
            updateSentenceDisplay();
            resultsDisplay.style.display = 'none';
            playQuestionAndSignal();
        }

        prevBtn.onclick = () => {
            if (isRecording) stopRecording();
            currentIndex = (currentIndex - 1 + sentences.length) % sentences.length;
            updateSentenceDisplay();
            if (isFreeMode) playCurrentSentence();
        };

        nextBtn.onclick = () => {
            if (isRecording) stopRecording();
            currentIndex = (currentIndex + 1) % sentences.length;
            updateSentenceDisplay();
            if (isFreeMode) playCurrentSentence();
        };

        replayBtn.onclick = () => {
            if (isRecording) stopRecording();
            if (isFreeMode) {
                playCurrentSentence();
            } else {
                playQuestionAndSignal();
            }
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            updateUIForMode();
            updateSentenceDisplay();
            if (isRecording) stopRecording();
        };

        testModeBtn.onclick = () => {
            if (!isFreeMode) return;
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            updateUIForMode();
            resetTestMode();
        };

        showHideBtn.onclick = () => {
            showQuestion = !showQuestion;
            showHideBtn.classList.toggle('active-mode', showQuestion);
            updateSentenceDisplay();
        };
        
        recordBtn.onclick = () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        };

        checkRecordBtn.onclick = () => {
            checkAndPlayRecording();
        };
        
        continueBtn.onclick = async () => {
            if (isRecording) stopRecording();
            
            if (currentIndex === sentences.length - 1) {
                if (window.confirm("Bạn muốn lưu lại bản ghi âm?")) {
                    await saveRecordings();
                }
                resetTestMode();
            } else {
                currentIndex = (currentIndex + 1);
                updateSentenceDisplay();
                playQuestionAndSignal();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            updateUIForMode();
            updateSentenceDisplay();
        });
    </script>
</body>
</html>